<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">
    <meta name="color-scheme" content="light dark">

    

    <meta name="author" content="ä½•æ™¨">
    <meta name="description" content="leveldb">
    <meta name="keywords" content="åšå®¢,developer,åç«¯æŠ€æœ¯,cs,computer science">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="leveldbç¬”è®°"/>
<meta name="twitter:description" content="leveldb"/>

    <meta property="og:title" content="leveldbç¬”è®°" />
<meta property="og:description" content="leveldb" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://hechen0.com/posts/leveldb-notes/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-02-17T10:58:28+08:00" />
<meta property="article:modified_time" content="2021-02-17T10:58:28+08:00" /><meta property="og:site_name" content="æŠ€æœ¯æˆé•¿ä¹‹é“" />



    <title>
  leveldbç¬”è®° Â· 
</title>

    
      <link rel="canonical" href="http://hechen0.com/posts/leveldb-notes/">
    

    <link rel="preload" href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as="font" type="font/woff2" crossorigin>

    
      
      
      <link rel="stylesheet" href="/css/coder.min.708686f8ab8176e91d44fcbe488a0fe0333b94f405cf18a52383d67ba22f0ccb.css" integrity="sha256-cIaG&#43;KuBdukdRPy&#43;SIoP4DM7lPQFzxilI4PWe6IvDMs=" crossorigin="anonymous" media="screen" />
    

    

    

    

    

    <link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

    <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

    

    <meta name="generator" content="Hugo 0.91.0" />
  </head>

  
  
  <body class="preload-transitions colorscheme-light"
        onload=""
  >
    
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/">
      
    </a>
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link" href="/posts/">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/">Home</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="http://hechen0.com/posts/leveldb-notes/">
              leveldbç¬”è®°
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa fa-calendar" aria-hidden="true"></i>
              <time datetime='2021-02-17T10:58:28&#43;08:00'>
                February 17, 2021
              </time>
            </span>
            <span class="reading-time">
              <i class="fa fa-clock-o" aria-hidden="true"></i>
              4-minute read
            </span>
          </div>
          
          
          <div class="tags">
  <i class="fa fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="/tags/infra/">infra</a>
    </span></div>

        </div>
      </header>

      <div>
        
        <h1 id="levedbæ˜¯ä»€ä¹ˆ">
  levedbæ˜¯ä»€ä¹ˆ
  <a class="heading-link" href="#levedb%e6%98%af%e4%bb%80%e4%b9%88">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h1>
<p>å®˜æ–¹è§£é‡Š</p>
<blockquote>
<p>LevelDB is a fast key-value storage library written at Google that provides an ordered mapping from string keys to string values.</p>
</blockquote>
<h1 id="è§£å†³çš„é—®é¢˜">
  è§£å†³çš„é—®é¢˜
  <a class="heading-link" href="#%e8%a7%a3%e5%86%b3%e7%9a%84%e9%97%ae%e9%a2%98">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h1>
<p>å†™å¤šä½™è¯»çš„åœºæ™¯</p>
<h1 id="æä¾›çš„æ ¸å¿ƒèƒ½åŠ›">
  æä¾›çš„æ ¸å¿ƒèƒ½åŠ›
  <a class="heading-link" href="#%e6%8f%90%e4%be%9b%e7%9a%84%e6%a0%b8%e5%bf%83%e8%83%bd%e5%8a%9b">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h1>
<h2 id="å…·å¤‡çš„èƒ½åŠ›">
  å…·å¤‡çš„èƒ½åŠ›
  <a class="heading-link" href="#%e5%85%b7%e5%a4%87%e7%9a%84%e8%83%bd%e5%8a%9b">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<ul>
<li>é”®å€¼æ˜¯ä»»æ„å­—èŠ‚æ•°ç»„</li>
<li>æŒ‰keyæœ‰åº&amp;å¯è‡ªå®šä¹‰æ’åºæ–¹æ³•</li>
<li>æ ¸å¿ƒæ“ä½œ Putï¼ŒGetï¼ŒDelete</li>
<li>æ‰¹é‡æ“ä½œ</li>
<li>å¿«ç…§</li>
<li>éå†</li>
<li>æ•°æ®å‹ç¼©</li>
<li>å¯¹å¤–äº¤äº’é€šè¿‡è™šæ‹Ÿå±‚è¿›è¡Œï¼Œç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰æ“ä½œç³»ç»Ÿå±‚åŠŸèƒ½ï¼ˆExternal activity (file system operations etc.) is relayed through a virtual interface so users can customize the operating system interactions.ï¼‰</li>
</ul>
<h2 id="ä¸å…·å¤‡çš„èƒ½åŠ›">
  ä¸å…·å¤‡çš„èƒ½åŠ›
  <a class="heading-link" href="#%e4%b8%8d%e5%85%b7%e5%a4%87%e7%9a%84%e8%83%bd%e5%8a%9b">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<ul>
<li>éSQLæ•°æ®åº“ï¼Œæ²¡æœ‰å…³ç³»æ•°æ®æ¨¡å‹ï¼Œä¸æ”¯æŒSQLæŸ¥è¯¢ï¼Œä¸æ”¯æŒç´¢å¼•</li>
<li>åªæ”¯æŒå•è¿›ç¨‹æ¨¡å¼ï¼ˆå¤šçº¿ç¨‹ï¼‰</li>
<li>åªæ˜¯ä¸ªlibåº“ï¼Œæ²¡æœ‰ç°æˆå¯ä»¥ä½¿ç”¨çš„client-serverï¼Œéœ€è¦è‡ªå·±å°è£…</li>
</ul>
<h1 id="èµ„æºç»“æ„ä¾èµ–">
  èµ„æºç»“æ„ä¾èµ–
  <a class="heading-link" href="#%e8%b5%84%e6%ba%90%e7%bb%93%e6%9e%84%e4%be%9d%e8%b5%96">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h1>
<p>libåº“ï¼Œéœ€è¦å’Œå…¶å®ƒç³»ç»Ÿé…åˆä½¿ç”¨ï¼Œå¯ä»¥å‚è€ƒbigtable</p>
<h1 id="æ¶æ„">
  æ¶æ„
  <a class="heading-link" href="#%e6%9e%b6%e6%9e%84">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h1>
<h2 id="æ•°æ®ç»“æ„">
  æ•°æ®ç»“æ„
  <a class="heading-link" href="#%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<h3 id="æ ¸å¿ƒæ•°æ®ç»“æ„">
  æ ¸å¿ƒæ•°æ®ç»“æ„
  <a class="heading-link" href="#%e6%a0%b8%e5%bf%83%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<ul>
<li>MemTable
<ul>
<li>ä»‹ç»
<ul>
<li>å†…å­˜ä¸­çš„æ•°æ®å­˜å‚¨ç»“æ„ï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½ä¼šå…ˆå†™å…¥MemTableï¼Œå†ç»è¿‡compactionåˆ°æ–‡ä»¶ä¸­</li>
</ul>
</li>
</ul>
</li>
<li>MemTableIterator
<ul>
<li>ä»‹ç»
<ul>
<li>å†…å­˜ä¸­MemTableçš„éå†ç»“æ„</li>
</ul>
</li>
</ul>
</li>
<li>SkipList
<ul>
<li>ä»‹ç»
<ul>
<li>å†…å­˜ä¸­çš„æ•°æ®å­˜å‚¨ç»“æ„ï¼Œè¯»å†™å¤æ‚åº¦ O(logn)</li>
</ul>
</li>
</ul>
</li>
<li>Table
<ul>
<li>ä»‹ç»
<ul>
<li>æ–‡ä»¶çš„æ•°æ®å­˜å‚¨ç»“æ„ï¼Œæ˜¯ä¸€ä¸ªæŒ‰keyæœ‰åºçš„mapï¼Œä¸å¯å˜</li>
</ul>
</li>
</ul>
</li>
<li>TableBuilder
<ul>
<li>ä»‹ç»
<ul>
<li>å°è£…å†™æ–‡ä»¶ç›¸å…³æ–¹æ³•</li>
</ul>
</li>
</ul>
</li>
<li>BlockBuilder
<ul>
<li>ä»‹ç»
<ul>
<li>å°è£…æ–‡ä»¶ä¸­ data blockã€meta blockç­‰å†™blockä¿¡æ¯</li>
</ul>
</li>
</ul>
</li>
<li>BlockHandle
<ul>
<li>ä»‹ç»
<ul>
<li>æ˜¯ä¸€ä¸ªæ–‡ä»¶æŒ‡é’ˆï¼ŒæŒ‡å‘æ–‡ä»¶ä¸­æŸä¸ªdata blockæˆ–è€…meta blockï¼Œç”¨offsetä»¥åŠsizeå¯¹blockè¿›è¡Œæ ‡è¯†</li>
</ul>
</li>
</ul>
</li>
<li>Version
<ul>
<li>ä»‹ç»
<ul>
<li>è®°å½•DBçš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œæ•°æ®ç»“æ„ä¸Šæ˜¯ä¸€ä¸ªåŒé“¾è¡¨</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="å…¶å®ƒæ•°æ®ç»“æ„">
  å…¶å®ƒæ•°æ®ç»“æ„
  <a class="heading-link" href="#%e5%85%b6%e5%ae%83%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<h2 id="ç®—æ³•è¿‡ç¨‹">
  ç®—æ³•/è¿‡ç¨‹
  <a class="heading-link" href="#%e7%ae%97%e6%b3%95%e8%bf%87%e7%a8%8b">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<h3 id="compaction">
  compaction
  <a class="heading-link" href="#compaction">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<p>åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µ</p>
<ol>
<li>å†…å­˜ä¸­çš„memtableè½¬æ¢ä¸ºimmutable memtable</li>
<li>immutable memtable â†’ level 0 æ–‡ä»¶</li>
<li>level N â†’ level N+1 æ–‡ä»¶åˆå¹¶</li>
</ol>
<p><strong>å†…å­˜é˜¶æ®µ</strong></p>
<p>æ“ä½œ</p>
<ul>
<li>
<p>å†…å­˜ä¸­æ­£åœ¨å†™çš„memtable å˜ä¸º immutable memtable</p>
<ul>
<li>å¦‚ä¸‹è¿›è¡ŒæŒ‡é’ˆæ›¿æ¢</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// db/db_impl.cc
</span><span class="c1"></span><span class="n">imm_</span> <span class="o">=</span> <span class="n">mem_</span><span class="p">;</span> <span class="c1">// å½“å‰å†™æ»¡çš„memtableèµ‹å€¼ç»™immutable memtable
</span><span class="c1"></span><span class="n">has_imm_</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">memory_order_release</span><span class="p">);</span>
<span class="n">mem_</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MemTable</span><span class="p">(</span><span class="n">internal_comparator_</span><span class="p">);</span> <span class="c1">// æ–°å»ºä¸€ä¸ªmemtable
</span><span class="c1"></span><span class="n">mem_</span><span class="o">-&gt;</span><span class="n">Ref</span><span class="p">();</span> <span class="c1">// èµ‹ç»™å½“å‰å†™å…¥çš„memtableæŒ‡é’ˆ
</span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>è§¦å‘æ¡ä»¶</p>
<ul>
<li>DBImpl::Putã€DBImpl::Delete è¿‡ç¨‹ å¦‚æœå½“å‰memtableå†™æ»¡</li>
</ul>
<p><strong>å†…å­˜åˆ°æ–‡ä»¶é˜¶æ®µ minor compaction</strong></p>
<p><img src="/img/leveldb_2.png" alt="leveldb-2"></p>
<p>å†…å­˜æ•°æ®æ ¼å¼</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown">1                               10
 o---&gt; o---------------------------------------------------------&gt; o    Top level
   1           3              2                    5
 o---&gt; o---------------&gt; o---------&gt; o---------------------------&gt; o    Level 3
   1        2        1        2              3              2
 o---&gt; o---------&gt; o---&gt; o---------&gt; o---------------&gt; o---------&gt; o    Level 2
   1     1     1     1     1     1     1     1     1     1     1 
 o---&gt; o---&gt; o---&gt; o---&gt; o---&gt; o---&gt; o---&gt; o---&gt; o---&gt; o---&gt; o---&gt; o    Bottom level
Head  1st   2nd   3rd   4th   5th   6th   7th   8th   9th   10th  NIL
      Node  Node  Node  Node  Node  Node  Node  Node  Node  Node
</code></pre></td></tr></table>
</div>
</div><p>è§£é‡Š</p>
<ol>
<li>æœ€åº•å±‚æ˜¯ä¸€ä¸ªæœ‰åºé“¾è¡¨</li>
<li>ä¸ºäº†åŠ å¿«å•é“¾è¡¨çš„æŸ¥è¯¢é€Ÿåº¦ï¼Œåœ¨å•é“¾è¡¨ä¹‹ä¸Šå¢åŠ äº†å¤šå±‚æŸ¥è¯¢é“¾æ¥ï¼Œç”¨äºå¿«é€Ÿè·³è¿‡å¤§éƒ¨åˆ†èŠ‚ç‚¹ï¼Œå°†æŸ¥è¯¢æ•ˆç‡ä»O(n)é™ä½ä¸ºO(log n)</li>
</ol>
<p>æ–‡ä»¶æ•°æ®æ ¼å¼</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html">// æ–‡ä»¶ä¸­æ ¼å¼
<span class="p">&lt;</span><span class="nt">beginning_of_file</span><span class="p">&gt;</span>
[data block 1]
[data block 2]
...
[data block N]
[meta block 1]
...
[meta block K]
[metaindex block]
[index block]
[Footer]        (fixed size; starts at file_size - sizeof(Footer))
<span class="p">&lt;</span><span class="nt">end_of_file</span><span class="p">&gt;</span>

// footeræ ¼å¼
metaindex_handle: char[p];     // Block handle for metaindex
index_handle:     char[q];     // Block handle for index
padding:          char[40-p-q];// zeroed bytes to make fixed length
                               // (40==2*BlockHandle::kMaxEncodedLength)
magic:            fixed64;     // == 0xdb4775248b80fb57 (little-endian)
</code></pre></td></tr></table>
</div>
</div><p>è§£é‡Š</p>
<ol>
<li>
<p>kvé”®å€¼å¯¹æŒ‰åºè¢«æ”¾ç½®åœ¨data blocksä¸­ï¼Œæ‰€æœ‰data blockè¢«ä»æ–‡ä»¶å¼€å¤´å¼€å§‹è¿ç»­çš„æ’åˆ—åœ¨ä¸€èµ·ã€‚æ¯ä¸€ä¸ªdata blockä½¿ç”¨ <code>block_builder.cc</code> ä¸­çš„ä»£ç è¿›è¡Œæ ¼å¼åŒ–å¤„ç†ï¼Œå¹¶è¿›è¡Œé€‰æ‹©æ€§çš„å‹ç¼©ã€‚</p>
</li>
<li>
<p>data blocksä¹‹åæ˜¯meta blocksã€‚æ‰€æœ‰çš„ meta blockså¦‚ä¸‹æ‰€ç¤ºã€‚æœªæ¥ä¼šæ·»åŠ æ›´å¤šçš„meta blocksç±»å‹ï¼Œæ¯ä¸ª meta blockä¹Ÿä½¿ç”¨ block_builder.cc è¿›è¡Œæ ¼å¼åŒ–å¤„ç†ä»¥åŠé€‰æ‹©æ€§çš„å‹ç¼©ã€‚</p>
<ul>
<li>
<p>&ldquo;filter&rdquo; Meta Block</p>
<p>å¦‚æœopenæ—¶ä¼ å…¥äº†<code>FilterPolicy</code> ï¼Œé‚£ä¹ˆæ¯ä¸ªç£ç›˜æ–‡ä»¶å°±ä¼šæœ‰è¿™ä¹ˆä¸€ä¸ª filter blockã€‚TBD: <a href="https://github.com/google/leveldb/blob/master/doc/table_format.md">https://github.com/google/leveldb/blob/master/doc/table_format.md</a></p>
</li>
<li>
<p>&ldquo;stats&rdquo; Meta Block æš‚æœªå®ç°</p>
<p>å­˜å‚¨ä»¥ä¸‹ä¿¡æ¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">data size
index size
key size (uncompressed)
value size (uncompressed)
number of entries
number of data blocks
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
<li>
<p>metaindex block. åŒ…å«meta blockçš„ç´¢å¼•ä¿¡æ¯ï¼Œkeyä¸ºmeta blockçš„åç§°ï¼Œvalueä¸ºå¯¹åº”çš„ BlockHandle</p>
</li>
<li>
<p>index block. åŒ…å«æ¯ä¸ªdata blockçš„ç´¢å¼•ä¿¡æ¯ï¼Œæ¯ä¸ªdata blockä¸­æœ‰ä¸€ä¸ªæ¡ç›®ï¼Œkeyä¸ºä¸€ä¸ª stringï¼Œ è¯¥stringä¸ºå¯¹åº”data blockä¸­çš„æœ€å¤§keyå€¼ï¼Œvalueä¸ºå¯¹åº”çš„BlockHandle</p>
</li>
<li>
<p>æœ€åæ˜¯å¤§å°å›ºå®šçš„footer blockï¼ŒåŒ…å«metaindexå’Œindexçš„BlockHandleã€zeroå¡«å……ç”¨å­—èŠ‚ä»¥åŠä¸€ä¸ªå¹»æ•°(ç”¨äºå¿«é€Ÿè¯†åˆ«æ–‡ä»¶æ ¼å¼)</p>
<ul>
<li>
<p>å¹»æ•°ï¼šconst uint64_t kTableMagicNumber = 0xdb4775248b80fb57ull;</p>
<blockquote>
<p>kTableMagicNumber was picked by running
echo <a href="http://code.google.com/p/leveldb/">http://code.google.com/p/leveldb/</a> | sha1sum
and taking the leading 64 bits.</p>
</blockquote>
</li>
</ul>
</li>
</ol>
<p><strong>æ“ä½œ</strong></p>
<ul>
<li>BackgroundCompaction immutable memtable dumpæˆlevel 0çš„sstable(sorted set table)
<ul>
<li>
<p>DBImpl::CompactMemTable ä¼˜å…ˆè¿›è¡Œå†…å­˜åˆ°æ–‡ä»¶çš„ minor compactionï¼›å®Œæˆåç›´æ¥return</p>
<p>åŸå› ï¼šTBDï¼Ÿ</p>
<ul>
<li>DBImpl::WriteLevel0Table
<ul>
<li>è·å–ä¸‹ä¸€ä¸ªæ–‡ä»¶å  <code>versions_ -&gt; NewFileNumber()</code></li>
<li>å†…å­˜åˆ°æ–‡ä»¶çš„è½¬æ¢ <code>BuildTable</code>
<ul>
<li>ä½¿ç”¨iteréå†memtable</li>
<li><code>TablerBuilder.Add</code> æ·»åŠ åˆ°æ–‡ä»¶ä¸­
<ul>
<li>å†™å…¥ data block</li>
</ul>
</li>
<li><code>TableBuilder::Finish</code> æŒ‰å¦‚ä¸‹é¡ºåºå†™å¯¹åº”çš„blockä¿¡æ¯
<ol>
<li>meta block (filter)</li>
<li>metaindex block</li>
<li>index block</li>
<li>footer</li>
</ol>
</li>
</ul>
</li>
<li>ç¡®ä¿æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­  <code>file -&gt; Sync()</code></li>
<li>æœ€åè¿›è¡Œé”™è¯¯æ£€æŸ¥</li>
</ul>
</li>
</ul>
</li>
<li>
<p>å†è¿›è¡Œ major compaction</p>
</li>
</ul>
</li>
</ul>
<p><strong>è§¦å‘æ¡ä»¶</strong></p>
<ul>
<li>
<p>åœ¨BackgroundCompactionä¸­è¿›è¡Œï¼Œå¦‚ä¸‹é˜¶æ®µä¼šå°è¯•è¿›è¡ŒCompaction</p>
<p>æ ¸å¿ƒæ€è·¯ï¼šcompactionç”±æ–‡ä»¶çŠ¶æ€å˜åŒ–è§¦å‘ï¼ˆæŸ¥è¯¢ä¹Ÿä¼šè§¦å‘æ–‡ä»¶çŠ¶æ€çš„å˜åŒ–ï¼‰ï¼Œæ²¡æœ‰æ–‡ä»¶çŠ¶æ€çš„å˜åŒ–åªéœ€è¦åœ¨æ‰“å¼€BDæ—¶è¿›è¡Œä¸€æ¬¡compactionå³å¯ï¼Œæ— éœ€ä¸€ä¸ªå®šæ—¶ä»»åŠ¡è¿›è¡Œè§¦å‘ã€‚</p>
<ul>
<li>DBImpl::Geté˜¶æ®µ å¦‚æœå†…å­˜ä¸­æ²¡æŸ¥è¯¢åˆ°ä¸”æ–‡ä»¶ä¸­æŸ¥è¯¢åˆ°äº†
<ul>
<li>ğŸ¤” ä¼˜åŒ–ç‚¹ï¼šç”¨æŸä¸ªæ–‡ä»¶çš„seeksæ¬¡æ•°ä¿¡æ¯å†³å®šä¸‹ä¸€æ¬¡compactçš„æ–‡ä»¶
<ul>
<li>åŸå› ï¼šå°†çƒ­ç‚¹æ–‡ä»¶å°½å¿«compactåˆ°ä¸‹ä¸€å±‚ï¼ŸTBD</li>
</ul>
</li>
</ul>
</li>
<li>DBImpl::Putã€DBImpl::Delete è¿‡ç¨‹ å¦‚æœå½“å‰memtableå†™æ»¡</li>
<li>DB::Open é˜¶æ®µï¼Œdbæ‰“å¼€é˜¶æ®µ</li>
<li>ä¸€æ¬¡BackgroundCompactionç»“æŸåï¼Œé€’å½’è°ƒç”¨BackgroundCompaction
<ul>
<li>åŸå› ï¼šPrevious compaction may have produced too many files in a level,so reschedule another compaction if needed.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>level N â†’ level N+1 æ–‡ä»¶åˆå¹¶ major compaction</strong></p>
<p><img src="/img/leveldb_1.png" alt="leveldb-1"></p>
<p><strong>æ“ä½œ</strong></p>
<ul>
<li><code>DBImpl::BackgroundCompaction</code>  è¿›è¡Œcompaction
<ul>
<li><code>DBImpl::CompactMemTable</code> ä¼˜å…ˆè¿›è¡Œminor compaction å°†å†…å­˜ä¸­çš„immutable memtable å†™åˆ°level 0çš„æ–‡ä»¶ä¸­</li>
<li>å†è¿›è¡Œmajor compaction
<ul>
<li><code>versions_-&gt;PickCompaction()</code> ç»„è£…æœ¬æ¬¡compactionçš„ç›¸å…³ä¿¡æ¯
<ul>
<li>éœ€è¦ç¡®å®šçš„ä¿¡æ¯
<ul>
<li>æœ¬æ¬¡compactionå‘ç”Ÿåœ¨å“ªä¸ªlevel</li>
<li>ç¡®å®šlevelå ç¡®å®šlevelä¸­çš„å“ªä¸ªæ–‡ä»¶è¿›è¡Œcompaction</li>
</ul>
</li>
<li>åˆ¤æ–­é€»è¾‘
<ul>
<li>ä¼˜å…ˆåˆ¤æ–­levelä¸­çš„æ•°æ®å¤§å°æ˜¯å¦è¶…è¿‡é˜ˆå€¼
<ul>
<li><code>current_-&gt;compaction_score_ &gt;= 1</code> åˆ¤æ–­å½“å‰æ˜¯å¦å­˜åœ¨æŸlevelå®é™…å­˜å‚¨æ•°æ®å·²ç»è¶…è¿‡è®¾å®šçš„é˜ˆå€¼ï¼Œlevel 1: 10M level 2: 100M ã€‚ã€‚ã€‚level 6: 1T
<ul>
<li>å¯¹äºlevel 0ç‰¹æ®Šå¤„ç†ï¼Œä¸æ˜¯æ ¹æ®è¯¥å±‚æ•°æ®å¤§å°ï¼Œè€Œæ˜¯æ ¹æ®level 0å±‚æ–‡ä»¶æ•°ï¼Œä¾æ®å¦‚ä¸‹ä¸¤ä¸ªåŸå› 
<ul>
<li>version_set.cc:1033 TBD</li>
</ul>
</li>
<li>å¯¹äºæœ€åä¸€å±‚ä¸è¿›è¡Œåˆ¤æ–­ï¼Œæœ€åä¸€å±‚ç†è®ºä¸Šå¯ä»¥å­˜å‚¨æ— é™å¤šçš„æ•°æ®</li>
</ul>
</li>
<li>ç¡®å®šå¥½compactionçš„levelåï¼ŒæŒ‘é€‰è¿›è¡Œcompactionçš„æ–‡ä»¶
<ul>
<li><code>compact_pointer_[config::kNumLevels]</code> å­˜å‚¨å†å²ä¸Šè¿›è¡Œcompactionçš„fileï¼ŒæŒ‰æ–‡ä»¶è½®æµè¿›è¡Œcompactionï¼Œç¡®ä¿æ¯ä¸ªæ–‡ä»¶éƒ½èƒ½è¿›è¡Œcompaction</li>
</ul>
</li>
</ul>
</li>
<li>æ²¡æœ‰è¶…è¿‡é˜ˆå€¼çš„å¯¹è®¿é—®çƒ­ç‚¹(é€šè¿‡seek_times)çš„æ–‡ä»¶è¿›è¡Œcompactionï¼ŒğŸ¤”  è¿™ä¸ªä¼˜åŒ–ç‚¹TBD</li>
</ul>
</li>
</ul>
</li>
<li><code>DBImpl::DoCompactionWork</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="å…¶å®ƒç®—æ³•è¿‡ç¨‹">
  å…¶å®ƒç®—æ³•/è¿‡ç¨‹
  <a class="heading-link" href="#%e5%85%b6%e5%ae%83%e7%ae%97%e6%b3%95%e8%bf%87%e7%a8%8b">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<h2 id="å…³ç³»">
  å…³ç³»
  <a class="heading-link" href="#%e5%85%b3%e7%b3%bb">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>TBD</p>
<h3 id="æ ¸å¿ƒå…³ç³»">
  æ ¸å¿ƒå…³ç³»
  <a class="heading-link" href="#%e6%a0%b8%e5%bf%83%e5%85%b3%e7%b3%bb">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<p>TBD</p>
<h3 id="å…¶å®ƒå…³ç³»">
  å…¶å®ƒå…³ç³»
  <a class="heading-link" href="#%e5%85%b6%e5%ae%83%e5%85%b3%e7%b3%bb">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<p>TBD</p>
<h1 id="api">
  API
  <a class="heading-link" href="#api">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h1>
<h2 id="æ ¸å¿ƒapi">
  æ ¸å¿ƒAPI
  <a class="heading-link" href="#%e6%a0%b8%e5%bf%83api">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<h3 id="get">
  Get
  <a class="heading-link" href="#get">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<p>æ‰¾åˆ°å¯¹åº”keyï¼Œä¸”sequenceNumberæœ€å¤§çš„value</p>
<ul>
<li>è¿‡ç¨‹æè¿°
<ul>
<li>memï¼ˆmemtable usingï¼‰ MemTable::Get åœ¨å½“å‰å†…å­˜ memtable ä¸­æœç´¢</li>
<li>imm ï¼ˆMemtable being compactedï¼‰MemTable::Get åœ¨å½“å‰å†…å­˜ memtable ä¸­æœç´¢</li>
<li>current Status Version::Get æ–‡ä»¶æœç´¢
<ul>
<li>ForEachOverlapping
<ul>
<li>level 0
<ul>
<li>æ¯”è¾ƒæ‰€æœ‰æ–‡ä»¶å¤§å°ä¸¤ç«¯å€¼ æ‰¾åˆ°æ‰€æœ‰å¯èƒ½æœ‰è¯¥keyçš„ level 0</li>
<li>éå†ä¸Šè¿°æ–‡ä»¶</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="put">
  Put
  <a class="heading-link" href="#put">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<ul>
<li>è¿‡ç¨‹æè¿°
<ul>
<li>MakeRoomForWrite ç¡®ä¿æœ‰ç©ºé—´å†™å…¥
<ul>
<li>å¾ªç¯æ£€æµ‹dbçŠ¶æ€ æŒ‰ä¼˜å…ˆçº§æ’åº
<ul>
<li>æ£€æµ‹åˆ°é”™è¯¯ç›´æ¥è¿”å›</li>
<li>kL0_SlowdownWritesTrigger = 8  ï¼ˆSoft limit on number of level-0 files. We slow down writes at this point.ï¼‰
<ul>
<li>sleep 1msï¼›å†™å…¥é™é€Ÿï¼Œé¿å…å‡ºç°æ¯›åˆº</li>
</ul>
</li>
<li>æ£€æµ‹å½“å‰ memtable æ˜¯å¦æœ‰ç©ºé—´ï¼Œæ˜¯åˆ™å…è®¸è¯¥æ¬¡å†™å…¥ï¼Œå½“å‰memtableç©ºé—´å¤§å° <code>size_t write_buffer_size = 4 * 1024 * 1024</code></li>
<li>æ£€æµ‹å½“å‰æ˜¯å¦æœ‰memtableæ­£åœ¨è¿›è¡Œminor compactionï¼Œæ˜¯åˆ™ç­‰å¾…å®Œæˆ</li>
<li>kL0_StopWritesTrigger = 12 ï¼ˆMaximum number of level-0 files. We stop writes at this point.ï¼‰ï¼Œæ˜¯åˆ™ç­‰å¾…major compactionå®Œæˆä»¥å‡å°‘level 0æ–‡ä»¶æ•°é‡</li>
<li>æ–°å»ºlogã€æ–°å»º memtable ã€ è§¦å‘compaction (èµ°åˆ°è¿™é‡Œæ ‡è¯†å½“å‰memtableè¢«å†™æ»¡)
<ul>
<li>æ–°æ–‡ä»¶å <code>VersionSet::next_file_number_++</code></li>
<li>æ–°memtable</li>
<li>å°è¯•è§¦å‘compaction æŒ‰ä¼˜å…ˆçº§æ’åº
<ul>
<li>æ£€æµ‹æ˜¯å¦å·²ç»è§¦å‘äº†</li>
<li>æ£€æµ‹DBæ˜¯å¦æ­£åœ¨è¢«åˆ é™¤ æ— éœ€è¿›è¡Œcompaction</li>
<li>æ£€æµ‹æ˜¯å¦æœ‰é”™è¯¯</li>
<li>æ£€æµ‹æ˜¯å¦æ»¡è¶³compactionå‰ç½®æ¡ä»¶</li>
<li>schedule compaction</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>WriteBatch SequenceNumber ç‰ˆæœ¬å·+1</li>
<li>Append log_-&gt;AddRecord  å†™æ—¥å¿—
<ul>
<li>æŒ‰ options.sync é…ç½®å†™æ–‡ä»¶ï¼š fsync ï¼ˆæ¯æ¬¡å†™å…¥éƒ½fsyncå¯¹æ€§èƒ½å½±å“æå¤§ï¼Œä½†æ•°æ®ä¸ä¼šä¸¢ï¼‰</li>
</ul>
</li>
<li>WriteBatchInternal::InsertInto å†™å†…å­˜ memtable</li>
</ul>
</li>
<li>ä¼˜åŒ–ç‚¹
<ul>
<li>leveldbä¸­å†™æ“ä½œä¸æ˜¯ç“¶é¢ˆï¼Œä½†å†™è¿‡å¤šä¼šå½±å“è¯»çš„æ•ˆç‡ï¼›æ‰€ä»¥ä¼šæœ‰ä¸€äº›åˆ—ç­–ç•¥é™åˆ¶å†™
<ul>
<li>å†™å¤šäº†ä¼šé€ æˆæ–‡ä»¶è¿‡å¤šï¼Œä»è€Œä½¿å¾—æŸ¥æ‰¾éœ€è¦å¤§é‡IOï¼Œå› ä¸ºæŸ¥æ–‡ä»¶éœ€è¦æ£€æŸ¥ä¸€éstartã€end</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>è¯¦ç»†è¿‡ç¨‹</p>
<p>åŸå› </p>
<ol>
<li>Status DB::Put(const WriteOptions&amp; opt, const Slice&amp; key, const Slice&amp; value)
<ol>
<li>WriteBatch batch; batch.Put(key, value);</li>
<li>return DBImpl::Write(const WriteOptions&amp; options, WriteBatch* updates)
<ol>
<li>new writer</li>
<li>MutexLock ä¸Šé”</li>
<li>writesè¿›é˜Ÿåˆ—</li>
</ol>
</li>
</ol>
</li>
</ol>
<h3 id="delete">
  Delete
  <a class="heading-link" href="#delete">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<h3 id="listiteration-éå†">
  List/Iteration éå†
  <a class="heading-link" href="#listiteration-%e9%81%8d%e5%8e%86">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<h3 id="snapshot">
  Snapshot
  <a class="heading-link" href="#snapshot">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<h2 id="å…¶å®ƒapi">
  å…¶å®ƒAPI
  <a class="heading-link" href="#%e5%85%b6%e5%ae%83api">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<h1 id="å‚è€ƒ">
  å‚è€ƒ
  <a class="heading-link" href="#%e5%8f%82%e8%80%83">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h1>
<ol>
<li>æºç ç‰ˆæœ¬ <a href="https://github.com/google/leveldb">https://github.com/google/leveldb</a> 5bd5f0f67a5eb0ed74c16b3ae847ec4e5bc3e412</li>
<li><a href="http://smalldatum.blogspot.com/2018/06/the-original-lsm-paper.html">http://smalldatum.blogspot.com/2018/06/the-original-lsm-paper.html</a></li>
<li><a href="https://github.com/facebook/rocksdb/wiki/Leveled-Compaction">https://github.com/facebook/rocksdb/wiki/Leveled-Compaction</a></li>
<li><a href="https://yuerblog.cc/wp-content/uploads/leveldb%E5%AE%9E%E7%8E%B0%E8%A7%A3%E6%9E%90.pdf">https://yuerblog.cc/wp-content/uploads/leveldbå®ç°è§£æ.pdf</a></li>
<li><a href="https://github.com/google/leveldb/blob/master/doc/table_format.md">https://github.com/google/leveldb/blob/master/doc/table_format.md</a></li>
<li><a href="https://leveldb-handbook.readthedocs.io/zh/latest/compaction.html">https://leveldb-handbook.readthedocs.io/zh/latest/compaction.html</a></li>
</ol>

      </div>


      <footer>
        


        
        
        
      </footer>
    </article>

    
  </section>

      </div>

      
  <footer class="footer">
    <section class="container">
      
      
        Â©
        
        2022
         ä½•æ™¨ 
      
      
         Â· 
        Powered by <a href="https://gohugo.io/">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/">Coder</a>.
      
      
    </section>
  </footer>


    </main>

    
      
      <script src="/js/coder.min.03b17769f4f91ae35667e1f2a1ca8c16f50562576cf90ff32b3179926914daa5.js" integrity="sha256-A7F3afT5GuNWZ&#43;HyocqMFvUFYlds&#43;Q/zKzF5kmkU2qU="></script>
    

    

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-57183016-8', 'auto');
	
	ga('send', 'pageview');
}
</script>

    

    

    

    

    

    
  </body>

</html>
